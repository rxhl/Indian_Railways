<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Indian Rail</title>
		
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">			
		<!-- D3.js and Bootstrap CSS libraries -->
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
		<!-- Importing Google fonts -->
		<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,600%7COswald" rel="stylesheet">
		<!-- Importing D3 Legend library by Susie Lu -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.21.0/d3-legend.min.js"></script>
		<style>
			.title {
				padding-top: 10px;
				font-family: "Oswald", sans-serif;
			}

			.subtitle {
				font-family: "Open Sans", sans-serif;
				margin-top: 10px;
			}

			.map-title {
				font-family: "Oswald", sans-serif;
				font-size: 30px;
			}

			.map-description {
				font-family: "Open Sans", sans-serif;
				font-size: 22px;
				margin-top: -15px;
			}

			.city-name {
				font-family: sans-serif;
				color: aliceblue;
				font-weight: bold;
				font-style: oblique;
				font-size: 15px;
			}
			
			.vivek {
				margin-top: -100px;
			}
			
			#worldMap {
				background-color: skyblue;
				opacity: 0.5;	
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1 class="display-3 text-center title">Indian Railways</h1>
			<div class="row justify-content-md-center">
				<div class="col-12 col-md-auto">
					<p class="lead subtitle">
						<strong>One of the world's largest rail networks with <span class="badge badge-primary">66,687 km</span> of track, <span class="badge badge-primary">7,216 stations</span> and carrying <span class="badge badge-primary">22 million</span> passengers daily.</strong>
					</p><hr>
				</div>
			</div>
			<div class="row justify-content-md-center">
				<div class="col-12 col-md-auto">
					<p class="map-title text-center">Statewise distribution of railway tracks</p>
					<div id="map"></div>		
				</div>
			</div>
			<div class="row justify-content-md-center">
				<div class="col-8 col-md-auto">
					<p class="lead subtitle vivek">The Indian Railways is divided into <span class="badge badge-primary">17 zones</span>. The Dibrugarhâ€“Kanyakumari <span class="badge badge-primary">Vivek Express</span> is the longest running train route in India, spanning <span class="badge badge-primary">4,233 km</span>.</p>
				</div>
			</div>
			<div class="row justify-content-md-center">
				<div class="col-12 col-md-auto">
					<hr>
					<p class="map-title text-center">A comparison of countries by rail transport network size</p>
					<div id="worldMap"></div>
					<hr>	
				</div>
			</div>
		</div>
		
		<script>
			//Width and height
			var w = 1000, h = 1000;
			
			//Create SVG element for India's map
			var svg = d3.select("#map")
						.append("svg")
						.attr("width", w)
						.attr("height", h);
			
			//Create SVG element for World's map
			var worldSvg = d3.select("#worldMap")
						.append("svg")
						.attr("width", w)
						.attr("height", h - 400);
			
			// Adding groups for layering
			var states = svg.append("g");
			var arcs = svg.append("g").attr("class","arcs");
			var longArc = svg.append("g").attr("class","arcs");
			var stations = svg.append("g");
			var world = worldSvg.append("g")
			var countries = worldSvg.append("g");	

			// Rail routes to HQ (New Delhi) in lon/lat form
			var zonalTrainRoutes = [
				{sourceLocation: [77.215956,28.613897],targetLocation: [83.357728,26.610168]}, // NDLS - GOR
				{sourceLocation: [77.215956,28.613897],targetLocation: [88.347602,22.567746]}, // NDLS - KOL
				{sourceLocation: [77.215956,28.613897],targetLocation: [78.4983,17.4399]}, // NDLS - SEC
				{sourceLocation: [77.215956,28.613897],targetLocation: [80.282953,13.079691]}, // NDLS - CHE
				{sourceLocation: [77.215956,28.613897],targetLocation: [72.832711,18.95238]}, // NDLS - BOM
				{sourceLocation: [77.215956,28.613897],targetLocation: [75.137985,15.351838]}, // NDLS - HUB
				{sourceLocation: [77.215956,28.613897],targetLocation: [75.820406,26.916129]}, // NDLS - JAI
				{sourceLocation: [77.215956,28.613897],targetLocation: [80.107287,23.328862]}, // NDLS - JAB
				{sourceLocation: [77.215956,28.613897],targetLocation: [81.896732,25.28596]}, // NDLS - ALL
				{sourceLocation: [77.215956,28.613897],targetLocation: [81.686986,22.395583]}, // NDLS - BIL
				{sourceLocation: [77.215956,28.613897],targetLocation: [85.825794,20.28315]}, // NDLS - BHU
				{sourceLocation: [77.215956,28.613897],targetLocation: [85.209009,25.690557]} // NDLS - HAJI			
			];
			
			var longestRoute = [
				{sourceLocation: [94.91542,27.485983],targetLocation: [77.549934,8.079252]} // DIB - KAN
			];
	
			var projection = d3.geoMercator()
							.translate([w/2, h/2 - 140])
							.center([80,25])
							.scale(1500);
			
			var worldProjection = d3.geoEquirectangular()
								.translate([w/2, h/2 - 200])
								.precision(.1)
								.scale(153);
			
			// Colors taken from colorbrewer2
			var color = d3.scaleLinear()
						.range(["#f7fbff", "#08306b"]); 

			//Default path generator
			var path = d3.geoPath()
						.projection(projection);
			
			var worldPath = d3.geoPath().projection(worldProjection);
	
			/* Legend begins */
			
			// Legend for choropleth created using http://d3-legend.susielu.com/
			var legendGroup = svg.append("g")
								.attr("scale", 2);
			
			var log = d3.scaleLog()
    				.domain([ 10, 1000, 10000 ])
    				.range(["#f7fbff", "#08306b"]);
				
			var bars = legendGroup.append("g")
  						.attr("class", "legendLog")
  						.attr("transform", "translate(600,50)");

			var logLegend = d3.legendColor()
							.cells([10, 50, 100, 500, 1000, 5000, 10000])
							.orient("horizontal")
							.shapeWidth(50)
							.labelFormat(d3.format(".0f"))
							.title("Total track length (km)")
							.scale(log);

			legendGroup.select(".legendLog").call(logLegend);
			
			var stationCircle = legendGroup.append("circle")
								.attr("cx", 610).attr("cy", 150).attr("r", 10).style("fill", "yellow")
           						.style("opacity", 0.9).attr("stroke", "black").attr("stroke-width, 1")
						
			var twoStations = legendGroup.append("circle").attr("cx", 800).attr("cy", 150)
								.attr("r", 10).attr("fill", "brown")
           						.attr("opacity", 0.9).attr("stroke", "black").attr("stroke-width, 1");
								
			var hqText = legendGroup.append("text").text("Zonal Railways HQ").attr("x", 630).attr("y", 155);
						
			var stationText = legendGroup.append("text").text("Railway Station").attr("x", 820).attr("y", 155);
							
			var routeText = legendGroup.append("text")
							.text("Train Route")
							.attr("x", 860)
							.attr("y", 208);
			
			var track = legendGroup.append("rect")
								.attr("x", 800).attr("y", 200)							
								.attr("height", 5).attr("width", 50)				
								.attr("fill", "#fc4e2a");
			var longestTrack = legendGroup.append("rect")
								.attr("x", 600).attr("y", 250)							
								.attr("height", 5).attr("width", 50)				
								.attr("fill", "green");
			var longestRouteText = svg.append("text")
							.text("Longest rail route in India").attr("x", 660).attr("y", 258);				
			
			var delhiHQ = legendGroup.append("rect")
								.attr("x", 601).attr("y", 190)
								.attr("height", 20).attr("width", 20)
								.attr("fill", "yellow").attr("stroke-width", 1).attr("stroke", "black");
			
			var delhiText = legendGroup.append("text")
							.text("National Railways HQ").attr("x", 630).attr("y", 208);
	
			/* Legend ends */
			
			// Loading three datasets using queue
			
			d3.queue()
				.defer(d3.json, "data/india.geojson")
				.defer(d3.csv, "data/indian-states.csv")
				.defer(d3.csv, "data/indian-stations.csv")
				.defer(d3.json, "data/world.json")
				.defer(d3.csv, "data/world-countries.csv")
				.await(function(error, json, data, citydata, worldJSON, countrydata) {
    				if (error) {
        				console.error('Oh dear, something went wrong: ' + error);
    				}
    				else {
						
					// Mapping track length of each state (indian-states.csv) to India's GeoJSON states(india.json) in order to create a choropleth
					for(var i = 0; i < data.length; i++) {
						var dataSet = data[i].state;
						var dataValue = parseFloat(data[i].value);

						for (var j = 0; j < json.features.length; j++) {
							var jsonState = json.features[j].properties.NAME_1;
							if(dataSet == jsonState) {
								json.features[j].properties.value = dataValue;
								break;
							}
						}
					} 
					
					// Defining colors for the choropleth
					color.domain([
						d3.min(data, function(d) { return d.value; }),
						d3.max(data, function(d) { return d.value; })
					]); 

					//Bind data and create one path per GeoJSON feature
					states.selectAll("path")
					   .data(json.features)
					   .enter()
					   .append("path")
					   .attr("d", path)
					   .attr("fill", function(d) {
							var value = d.properties.value;
							if(value) {
								return color(value);
							} else
								return "#ccc";

					});
						
					// Drawing world map
					world.selectAll("worldPath")
						.data(worldJSON.features)
						.enter().append("path")
						.attr("d", worldPath)
						.attr("fill","#eaeaea")
						.attr("stroke","black").attr("stroke-width", 0.5);
						
					// Drawing country circle
					countries.selectAll(".world-countries")
						.data(countrydata)
						.enter()
						.append("circle")
						.attr("cx", function(d) {
							return worldProjection([d.lon, d.lat])[0];
						})
						.attr("cy", function(d) {
							return worldProjection([d.lon, d.lat])[1];
						})
					
						.attr("r", function(d) {
							return Math.sqrt(d.size / 300);
						})
						
						.attr("fill", function(d) {
							if (d.name == "India") {
							return "green";
						} else return "yellow";
						})
           				
						.attr("opacity", 0.8)
						.attr("stroke", "black")
						.attr("stroke-width, 1");

					
					// Draw circles for each station					
					stations.selectAll(".indian-stations")
						.data(citydata)
						.enter()
						.append("circle")
						.attr("cx", function(d) {
							return projection([d.lon, d.lat])[0];
						})
						.attr("cy", function(d) {
							return projection([d.lon, d.lat])[1];
						})
					
						.attr("r", function(d) {
							if (d.name == "New Delhi") {
								return 0;
							} else return 7;
						})
						
						.attr("fill", function(d) {
							if (d.name == "Dibrugarh" || d.name == "Kanyakumari") {
							return "brown";
						} else return "yellow";
						})
           				
						.attr("opacity", 0.95)
						.attr("stroke", "black")
						.attr("stroke-width, 1");
					
					// Draw square for New Delhi (Main HQ)
					var Delhi = svg.append("rect")
								.attr("x", 415.113).attr("y", 245.969)
								.attr("height", 20).attr("width", 20)
								.attr("fill", "yellow").attr("stroke-width", 1).attr("stroke", "black");
					
					// Write city names
					stations.selectAll(".indian-stations")
								.data(citydata)
								.enter()
								.append("text")
								.text(function(d) { return d.name; })
								.attr("x", function(d) { 
									if (d.name == "New Delhi") {
										return projection([d.lon, d.lat])[0] - 90;
									} else
									return projection([d.lon, d.lat])[0] + 10; 
								})
								.attr("y", function(d) { 
									return projection([d.lon, d.lat])[1] + 15; 
								})
								.attr("class", "city-name");		
						
					// Draw arcs between stations
					arcs.selectAll("path")
						.data(zonalTrainRoutes)
						.enter().append("path").attr("fill", "none")
						.attr("stroke", "#fc4e2a").attr("stroke-width", "3")
						.attr('d', function(d) { 
						return makeArc(d, 'sourceLocation', 'targetLocation', 4); 
						});
					
					// Draw arc for longest train route
					longArc.selectAll("path")
						.data(longestRoute)
						.enter().append("path").attr("fill", "none")
						.attr("stroke", "green").attr("stroke-width", "3")
						.attr('d', function(d) { 
						return makeArc(d, 'sourceLocation', 'targetLocation', 0.9); 
						});
					}
				});
			
			// Function to create arcs
			function makeArc(d, sourceName, targetName, bend){
			var sourceLngLat = d[sourceName],
				targetLngLat = d[targetName];

			if (targetLngLat && sourceLngLat) {
				var sourceXY = projection(sourceLngLat),
					targetXY = projection(targetLngLat);

				if (!targetXY) console.log(d, targetLngLat, targetXY)
				var sourceX = sourceXY[0], sourceY = sourceXY[1];
					
				var targetX = targetXY[0], targetY = targetXY[1];
						
				var dx = targetX - sourceX, dy = targetY - sourceY, dr = Math.sqrt(dx * dx + dy * dy)*bend;

				var west_of_source = (targetX - sourceX) < 0;

				if (west_of_source) 
				{
					return "M" + targetX + "," + targetY + "A" + dr + "," + dr + " 0 0,1 " + sourceX + "," + sourceY;
				}
				else {
					return "M" + sourceX + "," + sourceY + "A" + dr + "," + dr + " 0 0,1 " + targetX + "," + targetY;
				}
			} 
			else {
				return "M0,0,l0,0z";
			}
		} 
		</script>
		
		<!-- jQuery and Bootstrap libraries -->	
		<script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>		
	</body>
</html>